version: 2.1
jobs:
  build:
    machine: true
    steps:
     - checkout
     - run: 
         name: Install docker-compose and build images
         command: |
           docker build -t webbb .
  push:
    machine: true
    steps:
     - run:
         name: Installing gcloud sdk and push images gcr
         command: |
           sudo apt update
           sudo apt-get install apt-transport-https ca-certificates gnupg
           curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
           sudo apt-get update
           sudo apt-get install -y google-cloud-sdk
           echo "Installed"
           echo "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiY2l0cmljLWVh
cnRoLTMxOTExNyIsCiAgInByaXZhdGVfa2V5X2lkIjogIjQ0MzViMTRlZWEzN2ZjOGM2ZWM0ZGEx
YjIzZmIyN2EzYzg4OTk5NzIiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUg
S0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9J
QkFRRDF1S2JJNlJkMHlJZXBcbmFOK05CcmZWL3VwdU92YWEwZzFUUnVqYy8zUjMvWTh1RTlHdGFM
V0VIaXZjWmVJMCtvS3B6cTdsZFd4U0dsQ3Fcbk1OOTFhTmVCUTMrYlZGc21uSGpjaUNKS0tCY1lI
cVN6Y1RlWVZYYWRsNzFpVlVNUko0b0pGZVJyOW1Xd0EwSThcbjZBOHI5RlBpOHlra0ZJcUdWNStR
UzA3aVRXWU52NC8rK2lWQ2pBNnhiQk5ycWhQNm5LTTIrckdGS1VwcGlPSUdcbmc5aXQzcmVocnR3
eExBNGlkalpNL0hrVjJIZjJJRlRYZU9TL3FQQ041YjhBL1NiYitrRFJaa2xsd1c0WVlRWUNcbjU3
RHI1cnRIYmFvM0ZWMGJtdkoyYm5UWUh1aUF4aVltTGl2SDhPaDhPVnNxdnJGV3BCRjBKT3VTT1h5
NzlCeDVcblEwMkViNndqQWdNQkFBRUNnZ0VBQ2tJYk5HZ0d3cWxjZ0lZUVR5TG9xZFpxa3crREhC
T0kydUVxOTQ3eW5jL0lcbkduUlpYSlB5Z0FHQ2MwRU5vSWlVeStJRkN5OUx4bUd5M0dnTjdDamtW
bEVyRXFFQzdTbTdJZm5NOUt1WHl6bjhcblJrR0R3S2hRdTJPS1ZJQ2F2Q3lhWnFhelVvNkcwRUpT
a1poZWljYzVlVkFOZDZRajVGZmtJWElEYVE4eUk0QzJcbjRMaDZNYWdLbTU2VTh3MXBYWFhrTU9l
aUVTR0YvVFFPakxBMkx5ckt6L2taOU1XMnZNY0I5T05HNjNRK1RWT2xcblZFZHBXamhrU0NMUnYv
VGczVDJ5TFFDRE55Ry9aS0E3RFZqR0hVWU8vQkpwb1BzNlFxWlJSTDdZQ0lsdmQwYnlcbm9xaU5s
L3JYa1dXL2tLU0dEdlRJTjM4TkJuRU5TRkNoSkdYNWtSZXdnUUtCZ1FEK1F2MzFySWhuK0V3Y3lM
U3ZcbmdGWHBiQ2tVZXBpV0R6Z3NjdWt1Ym11TFdmM2pYNkRIVml1cnhqNlo5M2w0a2dpWElETUJY
UXJEb1lESG9YQU5cbmVySE1hU0hOMEZhTWhwZXU0MGQ4Q1h6NFR2Ly91dVdwMzVvdjdQM05MMjZL
ZEFDL1B0MlREQWx0dE9Xc3NpcGpcbjNOTzRCRWhMb1QrZ0xhb3N6ZzRpNTBFWWh3S0JnUUQzWnJa
TWxFN2F4enhheWFsZ2Qxb0lnRnNRL2tDeGVrK2NcbkRucjFLT2NDMmduZUVmTCt0SXlINm81YmZx
THpSSGpOY1Rjam0xZnovREtqUnZwUEU1SGRzdDZwUnhyczh5R3lcbnEvNHkwazJxMFYrb3E2TnJr
c2VCSUtKY0hWTE14RSt6MmtxVnNLS29DdkpJRW1WRUt2T2JxQklZc01nY0RieFRcbmdKK21OY1Fp
aFFLQmdRQ2pGTzcxQzRPMlJCRDFpVm96RXZxSHJFTXhDbTBpR29McUo0NGVwTjQvMUNtL0U4LzRc
bjZ2RTV6UDdNSEdvQ0JwQ1I5aW9nM3IrUHVOL3pxejFHdUFLZ1hISTlJenJRQ1dmeTJYNDVOWkM5
WjFaVmZWZmZcblBEY1dORWladWFtS0RsdUlUdGNwZ05mdlVNN2JsSzhSdkVyanhZTmxWdmlMVVo3
TC9DSWZDdnE2c3dLQmdGdzNcbklNUXlrNkhnbVpLTmtHQ3duQktISldxVUdyRU1raGZ0SGMrN3l6
KzQzZXkwYkFxY2FiVlBySGhXSDQ3bGV0RzRcbjNZQ2NLcEI2OUxUL2c5VnR5ZlVFOHhITnV5K1BB
SVNFcjE5cUhDRUxvY2hSRWJ6TEhTbjRiQXhCc2RjNVpTdjRcbnRjeE41cE1VWVhLVHlNTTc3MG1a
d0FVTC84clZJOWxNSERYcjNJdXhBb0dBTXpaTWRETUZ6b2QzZ3RKcDJTcVBcblpXaDZ1V3ZIMjI5
NUJyT25rK1hOYkVLcWdWWkdLSEs4QURheWFzS0lPWjB3SWtRbERpWStKREp0YjZ2Ums4M3ZcbmZ4
MEQwZFNPVzR5QWRJYnJWbEJ2bitaTGlkdG45d09hQVlZQmxCYThFZDc0Ym1XVGlvcmpCT0Nld3VD
NldXSVlcbmFqTFo5YW9QVlVYWlhzTzFXVWRqdVlJPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0t
LVxuIiwKICAiY2xpZW50X2VtYWlsIjogImNpcmNsZWNpQGNpdHJpYy1lYXJ0aC0zMTkxMTcuaWFt
LmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTAzOTA0MTU3ODQ4NDUwOTMz
NzkwIiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgy
L2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9r
ZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xl
YXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0
cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9jaXJjbGVjaSU0
MGNpdHJpYy1lYXJ0aC0zMTkxMTcuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iCn0K" > gcloud_service_key.txt
           cat gcloud_service_key.txt
           sleep 10
           gcloud auth activate-service-account --key-file=gcloud_service_key.txt
           gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
           gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
           docker push eu.gcr.io ${GOOGLE_PROJECT_ID} webbb
workflows:
  version: 2.1
  build_and_push:
    jobs:
      - build:
         filters:
           branches:
             only: master
      - push:
         requires:
           - build